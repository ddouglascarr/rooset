---
label: Issue Aggregate - Voting Tests
key: issue-aggregate-voting-command
type: DOMAIN_COMMAND_TEST

mocks:
  - &unitId 464b1ebb-32c1-460c-8e9e-000000000000
  - &managerId 464b1ebb-32c1-460c-8e9e-111111111111
  - &areaId 464b1ebb-32c1-460c-8e9e-222222222222
  - &issueId 464b1ebb-32c1-460c-8e9e-333333333333
  - &policyId 464b1ebb-32c1-460c-8e9e-888888888888
  - &initiativeB 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
  - &initiativeC 464b1ebb-32c1-460c-8e9e-cccccccccccc
  - &initiativeD 464b1ebb-32c1-460c-8e9e-dddddddddddd

  - &voter0 464b1ebb-32c1-460c-8e9f-000000000000
  - &voter1 464b1ebb-32c1-460c-8e9f-111111111111
  - &voter2 464b1ebb-32c1-460c-8e9f-222222222222
  - &voter3 464b1ebb-32c1-460c-8e9f-333333333333
  - &voter4 464b1ebb-32c1-460c-8e9f-444444444444
  - &voter5 464b1ebb-32c1-460c-8e9f-555555555555
  - &voter6 464b1ebb-32c1-460c-8e9f-666666666666
  - &voter7 464b1ebb-32c1-460c-8e9f-777777777777
  - &voter8 464b1ebb-32c1-460c-8e9f-888888888888 # weight = 2

  - &unitCreatedEvt
    type: UNIT_CREATED_EVENT
    payload:
      id: *unitId
      requesterId: *managerId
      name: Test Unit
      description: The Test Unit

  - &areaCreatedEvt
    type: AREA_CREATED_EVENT
    payload:
      id: *unitId
      requesterId: *managerId
      areaId: *areaId
      name: test area
      description: the test area
      externalReference: 'area.com'

  - &privGrantedEvtVoter0
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: *unitId
      requesterId: *managerId
      memberId: *voter0
      votingRight: true
      managementRight: false
      pollingRight: false
      initiativeRight: true
      weight: 1

  - &unitPolicySetEvt
    type: UNIT_POLICY_SET_EVENT
    payload:
      id: *unitId
      requesterId: *managerId
      policyId: *policyId
      name: Test Policy
      description: The Test Policy
      polling: false
      maxAdmissionTime: 604800000
      minAdmissionTime: 0
      discussionTime: 604800000
      verificationTime: 604800000
      votingTime: 604800000
      issueQuorumNum: 1
      issueQuorumDen: 5
      defeatStrength: SIMPLE
      directMajorityNum: 1
      directMajorityDen: 2
      directMajorityStrict: true
      directMajorityPositive: 1
      directMajorityNonNegative: 1
      noReverseBeatPath: false
      noMultistageMajority: false

  - &privGrantedPayload
    id: *unitId
    requesterId: *managerId
    memberId: REPLACE_ME
    pollingRight: true
    votingRight: true
    initiativeRight: true
    managementRight: true
    weight: 1

  - &newInitiativeCreatedEvt
    type: NEW_INITIATIVE_CREATED_EVENT
    payload:
      id: *issueId
      requesterId: *voter0
      initiativeId: *initiativeB
      unitId: *unitId
      areaId: *areaId
      policyId: *policyId
      name: 'Test Initiative'
      polling: false
      externalReference: ''
      content: 'mock content'
      textSearchData: 'foo, bar'
      created: 1483586759

  - &competingInitiativeCreatedPayload
    id: *issueId
    requesterId: *voter1
    initiativeId: REPLACE ME
    name: 'Test Competing Initiative'
    externalReference: 'foobar'
    content: 'mock competing content'
    textSearchData: 'bing, bong'
    created: replace me

  - &issueVerificationPhaseCompletedEvt
    type: ISSUE_VERIFICATION_PHASE_COMPLETED_EVENT
    payload:
      id: *issueId
      passingInitiatives:
        - *initiativeB
        - *initiativeC
        - *initiativeD

  - &setIssueBallotCmd
    type: SET_ISSUE_BALLOT_COMMAND
    payload: REPLACE ME

  - &issueBallotSetEvt
    type: ISSUE_BALLOT_SET_EVENT
    payload: REPLACE ME

  - &unsetIssueBallotCmd
    type: UNSET_ISSUE_BALLOT_COMMAND
    payload:
      id: *issueId
      requesterId: *voter0

  - &issueBallotUnsetEvt
    type: ISSUE_BALLOT_UNSET_EVENT
    payload:
      id: *issueId
      requesterId: *voter0

  - &notFoundErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: ITEM_NOT_FOUND_EXCEPTION
      message: ''
  - &unprivilegedErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: UNPRIVILEGED_EXCEPTION
      message: ''
  - &conflictErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: CONFLICT_EXCEPTION
      message: ''
  - &issueStateErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: ISSUE_STATE_EXCEPTION
      message: ''

scenarios:


  -
    label: Must be in voting phase to cast ballot
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter0
    when:
      <<: *setIssueBallotCmd
      payload:
        id: *issueId
        requesterId: *voter0
        ballot:
          approve:
            -
              - *initiativeB
          abstain:
            - *initiativeC
          disapprove:
            -
              - *initiativeC
    then: *issueStateErr


  -
    label: Voter must be privileged
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      - *issueVerificationPhaseCompletedEvt
    when:
      <<: *setIssueBallotCmd
      payload:
        id: *issueId
        requesterId: *voter0
        ballot:
          approve:
            -
              - *initiativeB
          abstain:
            - *initiativeC
          disapprove:
            -
              - *initiativeD
    then: *unprivilegedErr


  -
    label: To unset a ballot the ballot must exist
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      - *issueVerificationPhaseCompletedEvt
    when: *unsetIssueBallotCmd
    then: *notFoundErr


  -
    label: Unset ballot
    given:
      key: ballot-cast
      precondition:
        - *unitCreatedEvt
        - *unitPolicySetEvt
        - *areaCreatedEvt
        - *newInitiativeCreatedEvt
        - *issueVerificationPhaseCompletedEvt
        -
          <<: *issueBallotSetEvt
          payload:
            id: *issueId
            requesterId: *voter0
            ballot:
              approve:
                -
                  - *initiativeB
              abstain:
                - *initiativeC
              disapprove:
                -
                  - *initiativeD
    when: *unsetIssueBallotCmd
    then: *issueBallotUnsetEvt


  -
    label: Set Ballot
    given:
      key: voting-phase
      precondition:
        - *unitCreatedEvt
        - *unitPolicySetEvt
        - *areaCreatedEvt
        - *privGrantedEvtVoter0
        - *newInitiativeCreatedEvt
        - *issueVerificationPhaseCompletedEvt
    when:
      <<: *setIssueBallotCmd
      payload:
        id: *issueId
        requesterId: *voter0
        ballot:
          approve:
            -
              - *initiativeB
          abstain:
            - *initiativeC
          disapprove:
            -
              - *initiativeD
    then:
      <<: *issueBallotSetEvt
      payload:
        id: *issueId
        requesterId: *voter0
        ballot:
          approve:
            -
              - *initiativeB
          abstain:
            - *initiativeC
          disapprove:
            -
              - *initiativeD


  -
    label: Unset ballot should fail on duplicate
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      - *issueVerificationPhaseCompletedEvt
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter0
          ballot:
            approve:
              -
                - *initiativeB
            abstain:
              - *initiativeC
            disapprove:
              -
                - *initiativeD
      - *issueBallotUnsetEvt
    when: *unsetIssueBallotCmd
    then: *notFoundErr


  - label: Should pick single winner in schulze ex 1
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload:
          <<: *competingInitiativeCreatedPayload
          initiativeId: *initiativeC
          created: 1484817333
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload:
          <<: *competingInitiativeCreatedPayload
          initiativeId: *initiativeD
          created: 1484817320
      - *issueVerificationPhaseCompletedEvt
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter0
          weight: 8
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter1
          weight: 2
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter2
          weight: 4
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter3
          weight: 4
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter4
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter5
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter6
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter0
          ballot:
            approve: []
            abstain: []
            disapprove:
              -
                - *initiativeC
              -
                - *initiativeD
              -
                - *initiativeB
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter1
          ballot:
            approve:
              -
                - *initiativeB
            abstain: []
            disapprove:
              -
                - *initiativeD
              -
                - *initiativeC
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter2
          ballot:
            approve:
              -
                - *initiativeC
              -
                - *initiativeD
              -
                - *initiativeB
            abstain: []
            disapprove: []
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter3
          ballot:
            approve:
              -
                - *initiativeD
              -
                - *initiativeB
            abstain: []
            disapprove:
              -
                - *initiativeC
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter4
          ballot:
            approve:
              -
                - *initiativeD
              -
                - *initiativeC
              -
                - *initiativeB
            abstain: []
            disapprove: []
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter5
          ballot:
            approve:
              -
                - *initiativeD
              -
                - *initiativeC
              -
                - *initiativeB
            abstain: []
            disapprove: []
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter6
          ballot:
            approve:
              -
                - *initiativeD
              -
                - *initiativeC
              -
                - *initiativeB
            abstain: []
            disapprove: []
    when:
      type: COMPLETE_ISSUE_VOTING_PHASE_COMMAND
      payload:
        id: *issueId
    then:
      type: ISSUE_VOTING_PHASE_COMPLETED_EVENT
      payload:
        id: *issueId
        winnerId: *initiativeD


  -
    label: should time based tie break on 2 schulze winners with delegations
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload:
          <<: *competingInitiativeCreatedPayload
          initiativeId: *initiativeC
          created: 1484817333
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload:
          <<: *competingInitiativeCreatedPayload
          initiativeId: *initiativeD
          created: 1484817332
      - *issueVerificationPhaseCompletedEvt
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter0
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter1
          weight: 2
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter2
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter3 # delegates to 0 at area, then votes itslef
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter4
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter5 # delegate to 4 at unit
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter6 # delegate to 0 at area
          weight: 1
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter7 # delegate to 0 at issue
          weight: 1
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter0
          ballot:
            approve: []
            abstain: []
            disapprove:
              -
                - *initiativeB
              -
                - *initiativeC
              -
                - *initiativeD
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter1
          ballot:
            approve:
              -
                - *initiativeC
              -
                - *initiativeB
              -
                - *initiativeD
            abstain: []
            disapprove: []
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter2
          ballot:
            approve:
              -
                - *initiativeD
            abstain: []
            disapprove:
              -
                - *initiativeB
              -
                - *initiativeC
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter3
          ballot:
            approve:
              -
                - *initiativeD
            abstain: []
            disapprove:
              -
                - *initiativeB
              -
                - *initiativeC
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter4
          ballot:
            approve:
              -
                - *initiativeD
              -
                - *initiativeB
              -
                - *initiativeC
            abstain: []
            disapprove: []
      -
        type: UNIT_DELEGATION_SET_EVENT
        payload:
          id: *unitId
          trusterId: *voter5
          trusteeId: *voter4
      -
        type: AREA_DELEGATION_SET_EVENT
        payload:
          id: *unitId
          areaId: *areaId
          trusterId: *voter6
          trusteeId: *voter0
      -
        type: AREA_DELEGATION_SET_EVENT
        payload:
          id: *unitId
          areaId: *areaId
          trusterId: *voter3 # gets overriden by voting directly
          trusteeId: *voter0
      -
        type: ISSUE_DELEGATION_SET_EVENT
        payload:
          id: *issueId
          trusterId: *voter7
          trusteeId: *voter0
    when:
      type: COMPLETE_ISSUE_VOTING_PHASE_COMMAND
      payload:
        id: *issueId
    then:
      type: ISSUE_VOTING_PHASE_COMPLETED_EVENT
      payload:
        id: *issueId
        winnerId: *initiativeB


  - label: Status quo should be able to be winner
    given:
      - *unitCreatedEvt
      - *unitPolicySetEvt
      - *areaCreatedEvt
      - *newInitiativeCreatedEvt
      - *issueVerificationPhaseCompletedEvt
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          <<: *privGrantedPayload
          memberId: *voter0
          weight: 1
      -
        <<: *issueBallotSetEvt
        payload:
          id: *issueId
          requesterId: *voter0
          ballot:
            approve: []
            abstain: []
            disapprove:
              -
                - *initiativeB
    when:
      type: COMPLETE_ISSUE_VOTING_PHASE_COMMAND
      payload:
        id: *issueId
    then:
      type: ISSUE_VOTING_PHASE_COMPLETED_EVENT
      payload:
        id: *issueId
        winnerId: null

