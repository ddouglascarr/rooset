---
label: Issue Aggregate - Lifecycle Tests
key: issue-lifecycle-command
type: DOMAIN_COMMAND_TEST

mocks:

  - &unitId 464b1ebb-32c1-460c-8e9e-111111111111
  - &requesterId 464b1ebb-32c1-460c-8e9e-222222222222

  - &unitCreatedEvent
    type: UNIT_CREATED_EVENT
    payload:
      id: *unitId
      requesterId: *requesterId
      name: Test Unit
      description: The Test Unit
      urlParameterName: test-unit

  - &areaCreatedEvent
    type: AREA_CREATED_EVENT
    payload:
      id: *unitId
      requesterId: *requesterId
      areaId: 464b1ebb-32c1-460c-8e9e-333333333333
      name: test area
      description: the test area
      externalReference: 'area.com'

  - &unitPolicySetEvent
    type: POLICY_CREATED_EVENT
    payload:
      id: *unitId
      requesterId: 464b1ebb-32c1-460c-8e9e-333333333333
      policyId: 464b1ebb-32c1-460c-8e9e-888888888888
      name: Test Policy
      description: The Test Policy
      votingAlgorithm: SCHULZE
      maxAdmissionTime: 604800000
      minAdmissionTime: 0
      discussionTime: 604800000
      verificationTime: 604800000
      votingTime: 604800000
      issueQuorumNum: 1
      issueQuorumDen: 5
      initiativeQuorumNum: 1
      initiativeQuorumDen: 5

  - &privGrantedEvtVoter4
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: *unitId
      requesterId: *requesterId
      memberId: 464b1ebb-32c1-460c-8e9e-444444444444
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: true
      weight: 1

  - &privGrantedEvtVoter5
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: *unitId
      requesterId: *requesterId
      memberId: 464b1ebb-32c1-460c-8e9e-555555555555
      pollingRight: true
      votingRight: true
      initiativeRight: false
      managementRight: true
      weight: 1

  - &createNewInitiativeCmdPayload
    id: 464b1ebb-32c1-460c-8e9e-666666666666
    requesterId: 464b1ebb-32c1-460c-8e9e-444444444444
    initiativeId: 464b1ebb-32c1-460c-8e9e-777777777777
    unitId: *unitId
    areaId: 464b1ebb-32c1-460c-8e9e-333333333333
    policyId: 464b1ebb-32c1-460c-8e9e-888888888888
    name: 'Test Initiative'
    polling: false
    externalReference: ''
    content: 'mock content'
    textSearchData: 'foo, bar'
    created: 1483586759

  - &createCompetingInitiativeCmdPayload
    id: 464b1ebb-32c1-460c-8e9e-666666666666
    requesterId: 464b1ebb-32c1-460c-8e9e-999999999999
    initiativeId: 464b1ebb-32c1-460c-8e9e-000000000000
    name: 'Test Competing Initiative'
    externalReference: 'foobar'
    content: 'mock competing content'
    textSearchData: 'bing, bong'
    created: 1483586759

  - &giveInitiativeSupportCmdPayload
    id: 464b1ebb-32c1-460c-8e9e-666666666666
    requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    initiativeId: 464b1ebb-32c1-460c-8e9e-000000000000

  - &giveInitiativeSupportCmd
    type: GIVE_INITIATIVE_SUPPORT_COMMAND
    payload: *giveInitiativeSupportCmdPayload

  - &initiativeSupportGivenEvt
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload: *giveInitiativeSupportCmdPayload

  - &revokeInitiativeSupportCmd
    type: REVOKE_INITIATIVE_SUPPORT_COMMAND
    payload: *giveInitiativeSupportCmdPayload

  - &initiativeSupportRevokedEvt
    type: INITIATIVE_SUPPORT_REVOKED_EVENT
    payload: *giveInitiativeSupportCmdPayload

  - &issueVerificationPhaseCompletedEvt
    type: ISSUE_VERIFICATION_PHASE_COMPLETED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      passingInitiatives:
        - 464b1ebb-32c1-460c-8e9e-777777777777

  - &notFoundErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: ITEM_NOT_FOUND_EXCEPTION
      message: ''
  - &unprivilegedErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: UNPRIVILEGED_EXCEPTION
      message: ''
  - &conflictErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: CONFLICT_EXCEPTION
      message: ''
  - &issueStateErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: ISSUE_STATE_EXCEPTION
      message: ''

scenarios:

  -
    label: Requester must have voting rights
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
    when: *giveInitiativeSupportCmd
    then: *unprivilegedErr

  -
    label: Initiative must exist to give support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
    when: *giveInitiativeSupportCmd
    then: *notFoundErr

  -
    label: Issue must be in right phase to give support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
      - *issueVerificationPhaseCompletedEvt
    when: *giveInitiativeSupportCmd
    then: *issueStateErr

  -
    label: Give Initiative Support
    given:
      key: initiatives-created
      precondition:
        - *unitCreatedEvent
        - *areaCreatedEvent
        - *privGrantedEvtVoter4
        - *privGrantedEvtVoter5
        - *unitPolicySetEvent
        -
          type: NEW_INITIATIVE_CREATED_EVENT
          payload: *createNewInitiativeCmdPayload
        -
          type: COMPETING_INITIATIVE_CREATED_EVENT
          payload: *createCompetingInitiativeCmdPayload
    when: *giveInitiativeSupportCmd
    then: *initiativeSupportGivenEvt

  -
    label: Give Initiative Support Should Fail on Duplicate
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
      - *initiativeSupportGivenEvt
    when: *giveInitiativeSupportCmd
    then: *conflictErr

  -
    label: Initiative must exist to revoke support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
    when: *revokeInitiativeSupportCmd
    then: *notFoundErr

  -
    label: Issue must be in right phase to revoke support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
      - *initiativeSupportGivenEvt
      - *issueVerificationPhaseCompletedEvt
    when: *revokeInitiativeSupportCmd
    then: *issueStateErr

  -
    label: Support must have been given to revoke support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
    when: *revokeInitiativeSupportCmd
    then: *notFoundErr

  -
    label: Revoke Initiative Support
    given:
      key: initiative-support-given
      precondition:
        - *unitCreatedEvent
        - *areaCreatedEvent
        - *privGrantedEvtVoter4
        - *privGrantedEvtVoter5
        - *unitPolicySetEvent
        -
          type: NEW_INITIATIVE_CREATED_EVENT
          payload: *createNewInitiativeCmdPayload
        -
          type: COMPETING_INITIATIVE_CREATED_EVENT
          payload: *createCompetingInitiativeCmdPayload
        - *initiativeSupportGivenEvt
    when: *revokeInitiativeSupportCmd
    then: *initiativeSupportRevokedEvt

  -
    label: Should fail on duplicate Revokation of support
    given:
      - *unitCreatedEvent
      - *areaCreatedEvent
      - *privGrantedEvtVoter4
      - *privGrantedEvtVoter5
      - *unitPolicySetEvent
      -
        type: NEW_INITIATIVE_CREATED_EVENT
        payload: *createNewInitiativeCmdPayload
      -
        type: COMPETING_INITIATIVE_CREATED_EVENT
        payload: *createCompetingInitiativeCmdPayload
      - *initiativeSupportGivenEvt
      - *initiativeSupportRevokedEvt
    when: *revokeInitiativeSupportCmd
    then: *notFoundErr
