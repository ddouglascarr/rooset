---
label: Support Caculation Tests
key: support-calculation-command
type: DOMAIN_COMMAND_TEST

mocks:

  - &unitCreatedEvt
    type: UNIT_CREATED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      name: Test Unit
      description: The Test Unit
      urlParameterName: test-unit

  - &areaCreatedEvt
    type: AREA_CREATED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      areaId: 464b1ebb-32c1-460c-8e9e-333333333333
      name: test area
      description: the test area
      externalReference: 'area.com'

  - &unitPolicySetEvt
    type: POLICY_ADDED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-333333333333
      policyId: 464b1ebb-32c1-460c-8e9e-222222222222
      name: Test Policy
      description: The Test Policy
      votingAlgorithm: SCHULZE
      maxAdmissionTime: 604800000
      minAdmissionTime: 0
      discussionTime: 604800000
      verificationTime: 604800000
      votingTime: 604800000
      issueQuorumNum: 1
      issueQuorumDen: 10
      initiativeQuorumNum: 1
      initiativeQuorumDen: 10

  - &newInitiativeCreatedEvt
    type: NEW_INITIATIVE_CREATED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      requesterId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa
      initiativeId: 464b1ebb-32c1-460c-8e9e-777777777777
      unitId: 464b1ebb-32c1-460c-8e9e-111111111111
      areaId: 464b1ebb-32c1-460c-8e9e-333333333333
      policyId: 464b1ebb-32c1-460c-8e9e-222222222222
      name: 'Test Initiative'
      polling: false
      externalReference: ''
      content: 'mock content'
      textSearchData: 'foo, bar'
      created: 1483586759


# Privileges

  - &voterA
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 2

  - &voterB
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 1

  - &voterC
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-cccccccccccc
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 3

  - &voterD
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-dddddddddddd
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 4

  - &voterE
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-eeeeeeeeeeee
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 1

  - &voterF
    type: PRIVILEGE_GRANTED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      requesterId: 464b1ebb-32c1-460c-8e9e-222222222222
      memberId: 464b1ebb-32c1-460c-8e9e-ffffffffffff
      pollingRight: true
      votingRight: true
      initiativeRight: true
      managementRight: false
      weight: 2


  # Delegations

  - &unitBtoA
    type: UNIT_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      trusterId: 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
      trusteeId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa

  - &unitCtoA
    type: UNIT_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      trusterId: 464b1ebb-32c1-460c-8e9e-cccccccccccc
      trusteeId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa

  - &unitDtoA
    type: UNIT_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      trusterId: 464b1ebb-32c1-460c-8e9e-dddddddddddd
      trusteeId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa

  - &unitEtoC
    type: UNIT_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      trusterId: 464b1ebb-32c1-460c-8e9e-eeeeeeeeeeee
      trusteeId: 464b1ebb-32c1-460c-8e9e-cccccccccccc

  - &areaEtoF
    type: AREA_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      areaId: 464b1ebb-32c1-460c-8e9e-333333333333
      trusterId: 464b1ebb-32c1-460c-8e9e-eeeeeeeeeeee
      trusteeId: 464b1ebb-32c1-460c-8e9e-ffffffffffff

  - &areaDBlocked
    type: DELEGATION_BLOCKED_FOR_AREA_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-111111111111
      areaId: 464b1ebb-32c1-460c-8e9e-333333333333
      trusterId: 464b1ebb-32c1-460c-8e9e-dddddddddddd

  - &issueCtoB
    type: ISSUE_DELEGATION_SET_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      trusterId: 464b1ebb-32c1-460c-8e9e-cccccccccccc
      trusteeId: 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb

  - &issueEBlocked
    type: DELEGATION_BLOCKED_FOR_ISSUE_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      trusterId: 464b1ebb-32c1-460c-8e9e-eeeeeeeeeeee

  # support

  - &supportA
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      requesterId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa
      initiativeId: 464b1ebb-32c1-460c-8e9e-777777777777

  - &supportC
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      requesterId: 464b1ebb-32c1-460c-8e9e-cccccccccccc
      initiativeId: 464b1ebb-32c1-460c-8e9e-777777777777

  - &supportF
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666
      requesterId: 464b1ebb-32c1-460c-8e9e-ffffffffffff
      initiativeId: 464b1ebb-32c1-460c-8e9e-777777777777

 # test quorum

  - &assessIssueAdmissionQuorumCmd
    type: ASSESS_ISSUE_ADMISSION_QUORUM_COMMAND
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666

  - &completeIssueAdmissionPhaseCmd
    type: COMPLETE_ISSUE_ADMISSION_PHASE_COMMAND
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666

  - &issueAdmissionQuorumContinuedEvt
    type: ISSUE_ADMISSION_QUORUM_CONTINUED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666

  - &issueAdmissionQuorumFailedEvt
    type: ISSUE_ADMISSION_QUORUM_FAILED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666

  - &issueAdmissionQuorumPassedEvt
    type: ISSUE_ADMISSION_QUORUM_PASSED_EVENT
    payload:
      id: 464b1ebb-32c1-460c-8e9e-666666666666

  # exceptions

  - &issueStateErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: ISSUE_STATE_EXCEPTION
      message: ''


scenarios:

  -
    label: Test compiles
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *unitBtoA
      - *unitCtoA
      - *unitDtoA
      - *unitEtoC
      - *areaEtoF
      - *areaDBlocked
      - *issueCtoB
      - *issueEBlocked
      - *supportA
      - *supportC
      - *supportF
    when:
      type: SET_AREA_DELEGATION_COMMAND
      payload:
        id: 464b1ebb-32c1-460c-8e9e-111111111111
        areaId: 464b1ebb-32c1-460c-8e9e-333333333333
        requesterId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa
        trusteeId: 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
    then:
      type: AREA_DELEGATION_SET_EVENT
      payload:
        id: 464b1ebb-32c1-460c-8e9e-111111111111
        areaId: 464b1ebb-32c1-460c-8e9e-333333333333
        trusterId: 464b1ebb-32c1-460c-8e9e-aaaaaaaaaaaa
        trusteeId: 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb

  -
    label: Issue must be in Admission phase for quorum assessment
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *issueAdmissionQuorumPassedEvt
    when: *assessIssueAdmissionQuorumCmd
    then: *issueStateErr

  -
    label: Issue must be in Admission phase for quorum complete
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *issueAdmissionQuorumPassedEvt
    when: *completeIssueAdmissionPhaseCmd
    then: *issueStateErr

  -
    label: Short of quorum should continue on assessment
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *unitBtoA
      - *unitCtoA
      - *unitDtoA
      - *unitEtoC
      - *areaEtoF
      - *areaDBlocked
      - *issueCtoB
      - *issueEBlocked
    when: *assessIssueAdmissionQuorumCmd
    then: *issueAdmissionQuorumContinuedEvt

  -
    label: Short of quorum should fail on complete
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *unitBtoA
      - *unitCtoA
      - *unitDtoA
      - *unitEtoC
      - *areaEtoF
      - *areaDBlocked
      - *issueCtoB
      - *issueEBlocked
    when: *completeIssueAdmissionPhaseCmd
    then: *issueAdmissionQuorumFailedEvt

  -
    label: Over quorum should pass on assessment
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *unitBtoA
      - *unitCtoA
      - *unitDtoA
      - *unitEtoC
      - *areaEtoF
      - *areaDBlocked
      - *issueCtoB
      - *issueEBlocked
      - *supportA
      - *supportC
      - *supportF
    when: *assessIssueAdmissionQuorumCmd
    then: *issueAdmissionQuorumPassedEvt

  - label: Over quorum should pass on complete
    given:
      - *unitCreatedEvt
      - *areaCreatedEvt
      - *unitPolicySetEvt
      - *voterA
      - *voterB
      - *voterC
      - *voterD
      - *voterE
      - *voterF
      - *newInitiativeCreatedEvt
      - *unitBtoA
      - *unitCtoA
      - *unitDtoA
      - *unitEtoC
      - *areaEtoF
      - *areaDBlocked
      - *issueCtoB
      - *issueEBlocked
      - *supportA
      - *supportC
      - *supportF
    when: *completeIssueAdmissionPhaseCmd
    then: *issueAdmissionQuorumPassedEvt
