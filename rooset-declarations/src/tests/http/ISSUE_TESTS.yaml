---
label: Http Issue Tests
key: issue-http
type: HTTP_API_TEST

mocks:
  - &issueId 464b1ebb-32c1-460c-8e9e-666666666666
  - &voter0Id 464b1ebb-32c1-460c-8e9f-000000000000
  - &voter4Id 464b1ebb-32c1-460c-8e9e-444444444444
  - &voter9Id 464b1ebb-32c1-460c-8e9e-999999999999
  - &areaId 464b1ebb-32c1-460c-8e9e-333333333333
  - &initiativeId 464b1ebb-32c1-460c-8e9e-777777777777
  - &competingInitiativeId 464b1ebb-32c1-460c-8e9e-000000000000
  - &unitId 464b1ebb-32c1-460c-8e9e-111111111111
  - &policyId 464b1ebb-32c1-460c-8e9e-888888888888
  - &created 1483586759
  - &competingCreated 1483586760
  - &initiativeB 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
  - &initiativeC 464b1ebb-32c1-460c-8e9e-cccccccccccc
  - &initiativeD 464b1ebb-32c1-460c-8e9e-dddddddddddd

  - &newInitiativeCreatedEvent
    type: NEW_INITIATIVE_CREATED_EVENT
    payload:
      id: *issueId
      requesterId: *voter4Id
      initiativeId: *initiativeId
      unitId: *unitId
      areaId: *areaId
      policyId: *policyId
      name: 'Test Initiative'
      polling: false
      externalReference: ''
      content: 'mock content'
      textSearchData: 'foo, bar'
      created: *created

  - &competingInitiativeCreatedEvent
    type: COMPETING_INITIATIVE_CREATED_EVENT
    payload:
      id: *issueId
      requesterId: *voter9Id
      initiativeId: *competingInitiativeId
      name: 'Test Competing Initiative'
      externalReference: 'foobar'
      content: 'mock competing content'
      textSearchData: 'bing, bong'
      created: *competingCreated

  # Support mocks, ids dont match up

  - &giveInitiativeSupportCmdPayload
    id: 464b1ebb-32c1-460c-8e9e-666666666666
    requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    initiativeId: 464b1ebb-32c1-460c-8e9e-000000000000

  - &initiativeSupportGivenEvt
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload: *giveInitiativeSupportCmdPayload

  - &revokeInitiativeSupportCmd
    type: REVOKE_INITIATIVE_SUPPORT_COMMAND
    payload: *giveInitiativeSupportCmdPayload

  - &initiativeSupportRevokedEvt
    type: INITIATIVE_SUPPORT_REVOKED_EVENT
    payload: *giveInitiativeSupportCmdPayload

scenarios:


  -
    label: Create new Initiative
    given: issue-creation-command/area-created
    when:
      action:
        type: HTTP_REQUEST
        uri: /issues
        method: POST
        requesterId: *voter4Id
        generate:
          id: *issueId
          initiativeId: *initiativeId
          created: *created
        body:
          unitId: *unitId
          areaId: *areaId
          policyId: *policyId
          name: 'Test Initiative'
          polling: false
          externalReference: ''
          content: 'mock content'
          textSearchData: 'foo, bar'
    then:
      outcome: *newInitiativeCreatedEvent


  -
    label: Create Competing Initiative
    given: issue-creation-command/issue-created
    when:
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives
        method: POST
        requesterId: *voter9Id
        generate:
          initiativeId: *competingInitiativeId
          created: *competingCreated
        body:
          name: 'Test Competing Initiative'
          externalReference: 'foobar'
          content: 'mock competing content'
          textSearchData: 'bing, bong'
    then:
      outcome: *competingInitiativeCreatedEvent


  -
    label: Give initiative Support
    given: issue-lifecycle-command/initiatives-created
    when:
      label: User gives support to initiative
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives/464b1ebb-32c1-460c-8e9e-000000000000
        method: PUT
        requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    then:
      label: A INITIATIVE_SUPPORT_GIVEN event is recorded
      outcome: *initiativeSupportGivenEvt


  -
    label: Revoke initiative Support
    given: issue-lifecycle-command/initiative-support-given
    when:
      label: User revokes support for an initiative
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives/464b1ebb-32c1-460c-8e9e-000000000000
        method: DELETE
        requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    then:
      label: a INITIATIVE_SUPPORT_REVOKED event is recorded
      outcome: *initiativeSupportRevokedEvt


  -
    label: Set Ballot on issue
    given: issue-voting-command/voting-phase
    when:
      label: A user sets a ballot on an issue
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-333333333333/ballot
        method: PUT
        requesterId: *voter0Id
        body:
          ballot:
            approve:
              -
                - *initiativeB
            abstain:
              - *initiativeC
            disapprove:
              -
                - *initiativeD
    then:
      label: ISSUE_BALLOT_SET_EVENT recorded
      outcome:
        type: ISSUE_BALLOT_SET_EVENT
        payload:
          id: 464b1ebb-32c1-460c-8e9e-333333333333
          requesterId: *voter0Id
          ballot:
            approve:
              -
                - *initiativeB
            abstain:
              - *initiativeC
            disapprove:
              -
                - *initiativeD


  -
    label: Unset Ballot on issue
    given: issue-voting-command/ballot-set
    when:
      label: A user unsets their ballot on an issue
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-333333333333/ballot
        method: DELETE
        requesterId: *voter0Id
    then:
      label: ISSUE_BALLOT_UNSET_EVENT recorded
      outcome:
        type: ISSUE_BALLOT_UNSET_EVENT
        payload:
          id: 464b1ebb-32c1-460c-8e9e-333333333333
          requesterId: *voter0Id
