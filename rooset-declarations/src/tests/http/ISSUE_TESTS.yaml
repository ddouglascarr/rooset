---
label: Http Issue Tests
key: issue-http
type: HTTP_API_TEST

mocks:
  - &unitId 464b1ebb-32c1-460c-8e9e-111111111111
  - &managerId 464b1ebb-32c1-460c-8e9e-222222222222
  - &areaId 464b1ebb-32c1-460c-8e9e-333333333333
  - &policyId 464b1ebb-32c1-460c-8e9e-888888888888
  - &otherPolicyId 464b1ebb-32c1-460c-8e9e-008888888880
  - &concernId 464b1ebb-32c1-460c-8e9e-111111111111
  - &otherConcernId 464b1ebb-32c1-460c-8e9e-001122334455
  - &voter1Id 464b1ebb-32c1-460c-8e9e-444444444444
  - &voter2Id 464b1ebb-32c1-460c-8e9e-555555555555
  - &voter3Id 464b1ebb-32c1-460c-8e9e-999999999999
  - &wrongId 464b1ebb-32c1-460c-8e9a-123412341234

  - &issueId 464b1ebb-32c1-460c-8e9e-666666666666
  - &initiativeId 464b1ebb-32c1-4601-8e91-111111111111
  - &competingInitiativeId 464b1ebb-32c1-4601-8e91-222222222222

  - &created 1483586759
  - &competingCreated 1483586760
  - &initiativeB 464b1ebb-32c1-460c-8e9e-bbbbbbbbbbbb
  - &initiativeC 464b1ebb-32c1-460c-8e9e-cccccccccccc
  - &initiativeD 464b1ebb-32c1-460c-8e9e-dddddddddddd

  - &newInitiativeCreatedEvent
    type: NEW_INITIATIVE_CREATED_EVENT
    payload:
      id: *issueId
      requesterId: *voter1Id
      initiativeId: *initiativeId
      unitId: *unitId
      areaId: *areaId
      concernId: *concernId
      policyId: *policyId
      name: 'Test Initiative'
      content: 'mock content'
      created: *created

  - &competingInitiativeCreatedEvent
    type: COMPETING_INITIATIVE_CREATED_EVENT
    payload:
      id: *issueId
      requesterId: *voter3Id
      initiativeId: *competingInitiativeId
      name: 'Test Competing Initiative'
      content: 'mock competing content'
      created: *competingCreated

  # Support mocks, ids dont match up

  - &giveInitiativeSupportCmdPayload
    id: 464b1ebb-32c1-460c-8e9e-666666666666
    requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    initiativeId: 464b1ebb-32c1-460c-8e9e-000000000000

  - &initiativeSupportGivenEvt
    type: INITIATIVE_SUPPORT_GIVEN_EVENT
    payload: *giveInitiativeSupportCmdPayload

  - &revokeInitiativeSupportCmd
    type: REVOKE_INITIATIVE_SUPPORT_COMMAND
    payload: *giveInitiativeSupportCmdPayload

  - &initiativeSupportRevokedEvt
    type: INITIATIVE_SUPPORT_REVOKED_EVENT
    payload: *giveInitiativeSupportCmdPayload

scenarios:


  -
    label: Create new Initiative
    given: issue-creation-command/area-created
    when:
      action:
        type: HTTP_REQUEST
        uri: /issues
        method: POST
        requesterId: *voter1Id
        generate:
          id: *issueId
          initiativeId: *initiativeId
          created: *created
        body:
          unitId: *unitId
          areaId: *areaId
          policyId: *policyId
          concernId: *concernId
          name: 'Test Initiative'
          content: 'mock content'
    then:
      outcome: *newInitiativeCreatedEvent


  -
    label: Create Competing Initiative
    given: issue-creation-command/issue-created
    when:
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives
        method: POST
        requesterId: *voter3Id
        generate:
          initiativeId: *competingInitiativeId
          created: *competingCreated
        body:
          name: 'Test Competing Initiative'
          content: 'mock competing content'
    then:
      outcome: *competingInitiativeCreatedEvent


  -
    label: Give initiative Support
    given: issue-lifecycle-command/initiatives-created
    when:
      label: User gives support to initiative
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives/464b1ebb-32c1-460c-8e9e-000000000000
        method: PUT
        requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    then:
      label: A INITIATIVE_SUPPORT_GIVEN event is recorded
      outcome: *initiativeSupportGivenEvt


  -
    label: Revoke initiative Support
    given: issue-lifecycle-command/initiative-support-given
    when:
      label: User revokes support for an initiative
      action:
        type: HTTP_REQUEST
        uri: /issues/464b1ebb-32c1-460c-8e9e-666666666666/initiatives/464b1ebb-32c1-460c-8e9e-000000000000
        method: DELETE
        requesterId: 464b1ebb-32c1-460c-8e9e-555555555555
    then:
      label: a INITIATIVE_SUPPORT_REVOKED event is recorded
      outcome: *initiativeSupportRevokedEvt
