---
label: Unit Aggregate Tests
mocks:
  - &unitId 464b1ebb-32c1-460c-8e9e-000000000000
  - &requesterId 464b1ebb-32c1-460c-8e9e-111111111111
  - &memberId 464b1ebb-32c1-460c-8e9e-222222222222

  - &createUnitCmdPayload
    id: *unitId
    requesterId: *requesterId
    name: Test Unit
    description: The Test Unit
    
  - &invalidInputErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: INVALID_INPUT_EXCEPTION
      message: ''
  - &unprivErr
    type: COMMAND_EVALUATION_EXCEPTION
    error: true
    payload:
      code: UNPRIVILEGED_EXCEPTION
      message: ''


scenarios:


  -
    label: Create Unit Scenario
    given: []
    when:
      -
        label: Create Unit
        payload:
          type: CREATE_UNIT_COMMAND
          payload: *createUnitCmdPayload
      -
        label: Create Unit Http
        payload:
          type: HTTP_REQUEST
          uri: '/units'
          method: POST
          requesterId: *requesterId
          generate:
            id: *unitId
          body:
            name: Test Unit
            description: The Test Unit
    then:
      -
        type: UNIT_CREATED_EVENT
        payload: *createUnitCmdPayload
      -
        type: UNIT_CREATED_EVENT
        payload: *createUnitCmdPayload


  -
    label: Unit Creator can grant privileges
    given:
      -
        type: UNIT_CREATED_EVENT
        payload:
          id: *unitId
          requesterId: *requesterId
          name: Test Unit
          description: The Test Unit
    when:
      -
        label: Unit Creator can grant privileges
        payload:
          type: GRANT_PRIVILEGE_COMMAND
          payload:
            id: *unitId
            requesterId: *requesterId
            memberId: *memberId
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 1
      -
        label: Member weight is restricted to 1
        payload:
          type: GRANT_PRIVILEGE_COMMAND
          payload:
            id: *unitId
            requesterId: *requesterId
            memberId: *memberId
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 2
      -
        label: Unit creator can grant privileges
        payload:
          type: HTTP_REQUEST
          uri: /units/464b1ebb-32c1-460c-8e9e-000000000000/members
          method: POST
          requesterId: *requesterId
          body:
            memberId: *memberId
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 1
      -
        label: Member weight is restricted to 1
        payload:
          type: HTTP_REQUEST
          uri: /units/464b1ebb-32c1-460c-8e9e-000000000000/members
          method: POST
          requesterId: *requesterId
          body:
            memberId: *memberId
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 2
      -
        label: Unprivileged member cannot grant privileges
        payload:
          type: GRANT_PRIVILEGE_COMMAND
          payload:
            id: *unitId
            requesterId: *memberId
            memberId: 464b1ebb-32c1-460c-8e9e-666666666666
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 1
      -
        label: Unprivileged member cannot grant privileges
        payload:
          type: HTTP_REQUEST
          uri: /units/464b1ebb-32c1-460c-8e9e-000000000000/members
          method: POST
          requesterId: *memberId
          body:
            memberId: 464b1ebb-32c1-460c-8e9e-666666666666
            pollingRight: true
            votingRight: true
            initiativeRight: true
            managementRight: true
            weight: 1
    then:
      - &localThenEvent
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          id: *unitId
          requesterId: *requesterId
          memberId: *memberId
          pollingRight: true
          votingRight: true
          initiativeRight: true
          managementRight: true
          weight: 1
      - *invalidInputErr
      - *localThenEvent
      - *invalidInputErr
      - *unprivErr
      - *unprivErr



  -
    label: Member without member privileges cannot grant privileges
    given:
      -
        type: UNIT_CREATED_EVENT
        payload:
          id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
          requesterId: 86998399-3d86-4e0b-a2a5-6490056ce43e
          name: Test Unit
          description: The Test Unit
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
          requesterId: 86998399-3d86-4e0b-a2a5-6490056ce43e
          memberId: f00b6b62-72d1-4c5e-974d-8a678f2c252c
          pollingRight: true
          votingRight: true
          initiativeRight: true
          managementRight: false
          weight: 1
    when:
      type: GRANT_PRIVILEGE_COMMAND
      payload:
        id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
        requesterId: f00b6b62-72d1-4c5e-974d-8a678f2c252c
        memberId: 6588b978-d3a8-4ed2-bd65-7157ab1f6016
        pollingRight: true
        votingRight: true
        initiativeRight: true
        managementRight: false
        weight: 1
    then:
      type: COMMAND_EVALUATION_EXCEPTION
      error: true
      payload:
        code: UNPRIVILEGED_EXCEPTION
        message: ''


  -
    label: Member with member privileges can grant privileges
    given:
      -
        type: UNIT_CREATED_EVENT
        payload:
          id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
          requesterId: 86998399-3d86-4e0b-a2a5-6490056ce43e
          name: Test Unit
          description: The Test Unit
      -
        type: PRIVILEGE_GRANTED_EVENT
        payload:
          id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
          requesterId: 86998399-3d86-4e0b-a2a5-6490056ce43e
          memberId: f00b6b62-72d1-4c5e-974d-8a678f2c252c
          pollingRight: true
          votingRight: true
          initiativeRight: true
          managementRight: true
          weight: 1
    when:
      type: GRANT_PRIVILEGE_COMMAND
      payload:
        id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
        requesterId: f00b6b62-72d1-4c5e-974d-8a678f2c252c
        memberId: 6588b978-d3a8-4ed2-bd65-7157ab1f6016
        pollingRight: true
        votingRight: true
        initiativeRight: true
        managementRight: false
        weight: 1
    then:
      type: PRIVILEGE_GRANTED_EVENT
      payload:
        id: 0c1fe645-4f57-4cfa-88d5-b2973f3f6bec
        requesterId: f00b6b62-72d1-4c5e-974d-8a678f2c252c
        memberId: 6588b978-d3a8-4ed2-bd65-7157ab1f6016
        pollingRight: true
        votingRight: true
        initiativeRight: true
        managementRight: false
        weight: 1

