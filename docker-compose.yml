---
version: "3.3"
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    ports:
      - "9443:443"
      - "9080:80"
      - "9022:22"
    volumes:
      - "./volumes/gitlab/config:/etc/gitlab"
      - "./volumes/gitlab/logs:/var/log/gitlab"
      - "./volumes/gitlab/data:/var/opt/gitlab"

  webhook_logger:
    build:
      context: ./log-server/
    command: "node index.js"

  db:
    image: postgres:12
    volumes:
      - './volumes/db:/var/lib/postgresql/data'

  lfcore:
    build:
      context: .
      dockerfile: core.Dockerfile
    links:
      - db
    env_file:
      - conf/dockerdev.env
    entrypoint: /usr/local/bin/keep-alive
    volumes:
      - ./lfcore:/opt/lfcore
      - ./etc:/opt/etc

  lffrontend:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    env_file:
      - conf/dockerdev.env
    ports:
      - "8081:8080"
    links:
      - db
    volumes:
      - ./lffrontend:/opt/frontend
      - ./lfframework:/opt/framework
      - ./etc:/opt/etc
    entrypoint: /usr/local/bin/keep-alive

  webpack:
    image: node:erbium-stretch
    volumes:
      - .:/go/src/github.com/ddouglascarr/rooset
    working_dir: /go/src/github.com/ddouglascarr/rooset
    command: npm run start
    ports:
      - "8082:8080"

  docvalidationsvc:
    image: node:erbium-stretch
    volumes:
      - .:/go/src/github.com/ddouglascarr/rooset
    working_dir: /go/src/github.com/ddouglascarr/rooset
    command: node_modules/.bin/nodemon dist/docvalidationsvc.js
    ports:
      - "8083:8080"

  docsvc:
    build:
      context: .
      dockerfile: docsvc.Dockerfile
    env_file:
      - conf/dockerdev.env
    volumes:
      - .:/go/src/github.com/ddouglascarr/rooset
    working_dir: /go/src/github.com/ddouglascarr/rooset
    command: go run cmd/rooset.go docsvc
    # command: /go/src/github.com/ddouglascarr/rooset/etc/keep-alive
    ports:
      - "8084:8080"
