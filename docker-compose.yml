---
version: "3.3"
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    ports:
      - "9443:443"
      - "9080:80"
      - "9022:22"
    volumes:
      - "./volumes/gitlab/config:/etc/gitlab"
      - "./volumes/gitlab/logs:/var/log/gitlab"
      - "./volumes/gitlab/data:/var/opt/gitlab"

  webhook_logger:
    build:
      context: ./log-server/
    command: "node index.js"

  db:
    image: postgres:12
    volumes:
      - './volumes/db:/var/lib/postgresql/data'

  lfcore:
    build:
      context: .
      dockerfile: core.Dockerfile
    links:
      - db
    environment:
      - PGHOST=db
      - PGUSER=postgres
      - PGDATABASE=liquid_feedback
      - CORE_SERVICES_INITIAL_DELAY=1
      - CORE_SERVICES_REPEAT_DELAY=3
    entrypoint: /usr/local/bin/keep-alive
    volumes:
      - ./lfcore:/opt/lfcore
      - ./etc:/opt/etc

  lffrontend:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    environment:
      - PGHOST=db
      - PGUSER=postgres
      - PGDATABASE=liquid_feedback
      - ROOSET_JWT_SECRET=development
    ports:
      - "8081:8080"
    links:
      - db
      - gitService
    volumes:
      - ./lffrontend:/opt/frontend
      - ./lfframework:/opt/framework
      - ./etc:/opt/etc
    entrypoint: /usr/local/bin/keep-alive

  webpack:
    image: node:erbium-stretch
    volumes:
      - .:/opt/rooset
    working_dir: /opt/rooset
    command: /opt/rooset/etc/keep-alive
    ports:
      - "8082:8080"

  gitService:
    image: node:erbium-stretch
    volumes:
      - ./clientts:/opt/clientts
      - ./etc:/opt/etc
    working_dir: /opt/clientts
    command: ./node_modules/.bin/nodemon dist/gitService.js
    ports:
      - "8083:8080"


